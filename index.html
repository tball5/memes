<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memes</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #00ff88;
      overflow-x: hidden;
      min-height: 100vh;
    }

    #rain-canvas {
      position: fixed;
      top: 0; left: 0;
      z-index: 0;
      pointer-events: none;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* HEADER */
    header {
      text-align: center;
      padding: 50px 20px 40px;
      border-bottom: 2px solid rgba(0,255,136,0.3);
      margin-bottom: 30px;
    }

    h1 {
      font-size: clamp(3em, 8vw, 5em);
      letter-spacing: 12px;
      text-shadow: 0 0 15px rgba(0,255,136,0.4);
      opacity: 0.6;
    }

    .meme-count {
      margin-top: 15px;
      font-size: 0.85em;
      opacity: 0.5;
      letter-spacing: 4px;
    }

    #memeCount { color: #00ff88; opacity: 1; }

    /* UPLOAD SECTION */
    .upload-section {
      margin-bottom: 40px;
      text-align: center;
    }

    .drop-zone {
      border: 2px dashed rgba(0,255,136,0.3);
      padding: 60px 40px;
      margin-bottom: 20px;
      transition: all 0.3s;
      background: rgba(0,255,136,0.02);
    }

    .drop-zone.drag-over {
      border-color: #00ff88;
      background: rgba(0,255,136,0.08);
      box-shadow: 0 0 30px rgba(0,255,136,0.2);
    }

    .drop-zone-text {
      font-size: 0.9em;
      opacity: 0.5;
      letter-spacing: 2px;
      margin-bottom: 20px;
    }

    #fileInput { display: none; }

    .btn {
      background: transparent;
      color: #00ff88;
      border: 1px solid #00ff88;
      padding: 14px 32px;
      font-size: 0.95em;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 2px;
      white-space: nowrap;
    }

    .btn:hover {
      background: #00ff88;
      color: #0a0a0a;
      box-shadow: 0 0 25px rgba(0,255,136,0.5);
      transform: scale(1.02);
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      border-color: #ff4455;
      color: #ff4455;
    }

    .btn-danger:hover {
      background: #ff4455;
      color: #0a0a0a;
      box-shadow: 0 0 25px rgba(255,68,85,0.5);
    }

    .upload-hint {
      margin-top: 15px;
      font-size: 0.75em;
      opacity: 0.4;
      letter-spacing: 1px;
    }

    /* STATUS */
    .status-msg {
      margin-top: 20px;
      font-size: 0.85em;
      letter-spacing: 1px;
      min-height: 1.2em;
      opacity: 0.7;
    }

    .status-msg.error { color: #ff4455; opacity: 1; }
    .status-msg.success { color: #00ff88; opacity: 1; }

    .progress-wrap {
      width: 100%;
      height: 4px;
      background: rgba(0,255,136,0.1);
      margin-top: 15px;
      display: none;
      overflow: hidden;
    }

    .progress-wrap.active { display: block; }

    .progress-bar {
      height: 100%;
      background: #00ff88;
      box-shadow: 0 0 10px #00ff88;
      width: 0%;
      transition: width 0.3s ease;
    }

    /* GALLERY */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 18px;
    }

    .meme-card {
      background: rgba(0,255,136,0.03);
      border: 1px solid rgba(0,255,136,0.2);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
    }

    .meme-card:hover {
      transform: translateY(-5px);
      border-color: #00ff88;
      box-shadow: 0 10px 35px rgba(0,255,136,0.3);
    }

    .meme-card img {
      width: 100%;
      height: 240px;
      object-fit: cover;
      display: block;
      transition: transform 0.3s;
    }

    .meme-card:hover img { transform: scale(1.04); }

    .card-overlay {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: rgba(10,10,10,0.95);
      padding: 12px;
      transform: translateY(100%);
      transition: transform 0.25s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .meme-card:hover .card-overlay { transform: translateY(0); }

    .icon-btn {
      background: transparent;
      border: 1px solid rgba(0,255,136,0.4);
      color: #00ff88;
      padding: 8px 16px;
      font-size: 0.75em;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .icon-btn:hover {
      background: #00ff88;
      color: #0a0a0a;
    }

    .icon-btn.del {
      border-color: rgba(255,68,85,0.4);
      color: #ff4455;
    }

    .icon-btn.del:hover {
      background: #ff4455;
      color: #0a0a0a;
    }

    /* EMPTY STATE */
    .empty-state {
      grid-column: 1/-1;
      text-align: center;
      padding: 100px 20px;
      opacity: 0.3;
      font-size: 1.1em;
      letter-spacing: 4px;
      line-height: 2.2;
    }

    /* LOADING */
    .loading {
      grid-column: 1/-1;
      text-align: center;
      padding: 80px;
      opacity: 0.4;
      letter-spacing: 3px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%,100% { opacity: 0.2; }
      50%      { opacity: 0.6; }
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      inset: 0;
      background: rgba(0,0,0,0.97);
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active { display: flex; }

    .modal-inner {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      animation: zoomIn 0.25s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    @keyframes zoomIn {
      from { transform: scale(0.85); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }

    .modal-inner img {
      max-width: 100%;
      max-height: 80vh;
      border: 2px solid rgba(0,255,136,0.5);
      box-shadow: 0 0 60px rgba(0,255,136,0.3);
      display: block;
    }

    .modal-actions { display: flex; gap: 12px; }

    .modal-close {
      position: absolute;
      top: -50px; right: 0;
      background: rgba(10,10,10,0.95);
      color: #00ff88;
      border: 1px solid rgba(0,255,136,0.4);
      width: 40px; height: 40px;
      font-size: 1.3em;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover { background: #00ff88; color: #0a0a0a; }

    /* PASSWORD MODAL */
    .pw-modal {
      display: none;
      position: fixed;
      z-index: 200;
      inset: 0;
      background: rgba(0,0,0,0.97);
      justify-content: center;
      align-items: center;
    }

    .pw-modal.active { display: flex; }

    .pw-box {
      background: rgba(10,10,10,0.98);
      border: 2px solid rgba(0,255,136,0.4);
      padding: 45px 50px;
      text-align: center;
      box-shadow: 0 0 60px rgba(0,255,136,0.2);
      min-width: 350px;
      animation: zoomIn 0.2s ease;
    }

    .pw-box h3 {
      letter-spacing: 5px;
      margin-bottom: 30px;
      font-size: 0.9em;
      opacity: 0.7;
    }

    .pw-input {
      background: rgba(0,255,136,0.05);
      border: 1px solid rgba(0,255,136,0.3);
      color: #00ff88;
      font-family: 'Courier New', monospace;
      padding: 14px 20px;
      font-size: 1em;
      width: 100%;
      text-align: center;
      outline: none;
      letter-spacing: 5px;
      margin-bottom: 25px;
    }

    .pw-input:focus { 
      border-color: #00ff88; 
      box-shadow: 0 0 20px rgba(0,255,136,0.2); 
    }

    .pw-error {
      color: #ff4455;
      font-size: 0.8em;
      margin-bottom: 20px;
      min-height: 1em;
      letter-spacing: 1px;
    }

    .pw-btns { display: flex; gap: 12px; justify-content: center; }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 50px 20px;
      margin-top: 70px;
      border-top: 1px solid rgba(0,255,136,0.15);
      font-size: 0.7em;
      opacity: 0.25;
      letter-spacing: 2px;
    }
  </style>
</head>
<body>

<canvas id="rain-canvas"></canvas>

<div class="container">
  <header>
    <h1>MEMES</h1>
    <div class="meme-count">
      <span id="memeCount">0</span> IN ARCHIVE
    </div>
  </header>

  <div class="upload-section">
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-text">DRAG IMAGES HERE OR</div>
      <input type="file" id="fileInput" accept="image/*" multiple>
      <button class="btn" onclick="document.getElementById('fileInput').click()" id="uploadBtn">
        + UPLOAD
      </button>
    </div>
    <div class="status-msg" id="statusMsg"></div>
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <div class="gallery" id="gallery">
    <div class="loading">INITIALIZING...</div>
  </div>
</div>

<footer>MEMES // FIREBASE STORAGE</footer>

<!-- Image Modal -->
<div class="modal" id="modal">
  <div class="modal-inner">
    <button class="modal-close" onclick="closeModal()">✕</button>
    <img id="modalImg" src="" alt="">
    <div class="modal-actions">
      <button class="btn" onclick="downloadCurrent()">⬇ DOWNLOAD</button>
      <button class="btn btn-danger" onclick="promptDeleteModal()">DELETE</button>
    </div>
  </div>
</div>

<!-- Password Modal -->
<div class="pw-modal" id="pwModal">
  <div class="pw-box">
    <h3>// ENTER PASSWORD //</h3>
    <input type="password" class="pw-input" id="pwInput" placeholder="PASSWORD" maxlength="20">
    <div class="pw-error" id="pwError"></div>
    <div class="pw-btns">
      <button class="btn" onclick="checkPassword()">CONFIRM</button>
      <button class="btn btn-danger" onclick="closePwModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  // ============================================================
  // FIREBASE CONFIG — paste your Firebase config here
  // ============================================================
  const firebaseConfig = {
    apiKey: "AIzaSyCHIDtqYhDi5EyCwbtTvAZGS0Nd4-3dkhE",
    authDomain: "click-me-8c931.firebaseapp.com",
    databaseURL: "https://click-me-8c931-default-rtdb.firebaseio.com",
    projectId: "click-me-8c931",
    storageBucket: "click-me-8c931.firebasestorage.app",
    messagingSenderId: "805463676341",
    appId: "1:805463676341:web:42e3a25681b755c2c175fc"
  };

  const DELETE_PASSWORD = 'burn';
  // ============================================================

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const storage = firebase.storage();
  const db = firebase.firestore();

  let memes = [];
  let currentMeme = null;
  let pendingDeleteMeme = null;

  // ── Matrix Rain ──────────────────────────────────────────────
  const rainCanvas = document.getElementById('rain-canvas');
  const ctx = rainCanvas.getContext('2d');
  rainCanvas.width = window.innerWidth;
  rainCanvas.height = window.innerHeight;
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()_+-=[]{}|;:\'",.<>?/～!！@#￥%……&*（）——+【】｛｝；：＂＇，。、《》？';
  const fontSize = 14;
  let columns = Math.floor(rainCanvas.width / fontSize);
  let drops = Array(columns).fill(1);

  function drawRain() {
    ctx.fillStyle = 'rgba(10,10,10,0.08)';
    ctx.fillRect(0, 0, rainCanvas.width, rainCanvas.height);
    ctx.fillStyle = '#00ff88';
    ctx.font = fontSize + 'px monospace';
    for (let i = 0; i < drops.length; i++) {
      ctx.fillText(chars[Math.floor(Math.random() * chars.length)], i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > rainCanvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
  }
  setInterval(drawRain, 45);
  window.addEventListener('resize', () => {
    rainCanvas.width = window.innerWidth;
    rainCanvas.height = window.innerHeight;
    columns = Math.floor(rainCanvas.width / fontSize);
    drops = Array(columns).fill(1);
  });

  // ── Anonymous Auth ───────────────────────────────────────────
  async function initAuth() {
    try {
      await auth.signInAnonymously();
      console.log('Authenticated anonymously');
      loadMemes();
    } catch (err) {
      console.error('Auth error:', err);
      showStatus('Authentication failed', 'error');
    }
  }

  // ── Load Memes from Firestore ────────────────────────────────
  async function loadMemes() {
    try {
      const snapshot = await db.collection('memes').orderBy('uploaded', 'desc').get();
      memes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      displayMemes();
    } catch (err) {
      console.error('Load error:', err);
      showStatus('Failed to load memes', 'error');
    }
  }

  // ── Upload Files ─────────────────────────────────────────────
  async function handleFiles(files) {
    const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
    if (!imageFiles.length) return;

    const btn = document.getElementById('uploadBtn');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');

    btn.disabled = true;
    progressWrap.classList.add('active');

    let uploaded = 0;

    for (let file of imageFiles) {
      showStatus(`Uploading ${uploaded + 1} of ${imageFiles.length}...`);
      try {
        // Upload to Firebase Storage
        const timestamp = Date.now();
        const filename = `${timestamp}_${Math.random().toString(36).substr(2, 9)}`;
        const storageRef = storage.ref(`memes/${filename}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();

        // Save metadata to Firestore
        await db.collection('memes').add({
          url: url,
          path: `memes/${filename}`,
          uploaded: firebase.firestore.FieldValue.serverTimestamp()
        });

        uploaded++;
        progressBar.style.width = (uploaded / imageFiles.length * 100) + '%';
      } catch (err) {
        console.error('Upload error:', err);
        showStatus(`Error uploading file`, 'error');
      }
    }

    btn.disabled = false;
    showStatus(`✓ ${uploaded} meme${uploaded > 1 ? 's' : ''} uploaded`, 'success');
    setTimeout(() => {
      progressWrap.classList.remove('active');
      progressBar.style.width = '0%';
      showStatus('');
    }, 3000);

    await loadMemes();
  }

  document.getElementById('fileInput').addEventListener('change', async function (e) {
    await handleFiles(e.target.files);
    e.target.value = '';
  });

  // Drag and Drop
  const dropZone = document.getElementById('dropZone');

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
  });

  dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    await handleFiles(e.dataTransfer.files);
  });

  // ── Display Gallery ──────────────────────────────────────────
  function displayMemes() {
    const gallery = document.getElementById('gallery');
    document.getElementById('memeCount').textContent = memes.length;

    if (!memes.length) {
      gallery.innerHTML = '<div class="empty-state">NO MEMES DETECTED<br>UPLOAD TO BEGIN</div>';
      return;
    }

    gallery.innerHTML = memes.map(m => `
      <div class="meme-card" onclick="openModal('${m.id}')">
        <img src="${m.url}" alt="meme" loading="lazy">
        <div class="card-overlay">
          <button class="icon-btn" onclick="event.stopPropagation(); downloadMeme('${m.id}')">⬇ Download</button>
          <button class="icon-btn del" onclick="event.stopPropagation(); promptDelete('${m.id}')">Delete</button>
        </div>
      </div>
    `).join('');
  }

  // ── Modal ────────────────────────────────────────────────────
  function openModal(id) {
    const meme = memes.find(m => m.id === id);
    if (!meme) return;
    currentMeme = meme;
    document.getElementById('modalImg').src = meme.url;
    document.getElementById('modal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('active');
    currentMeme = null;
  }

  document.getElementById('modal').addEventListener('click', function (e) {
    if (e.target === this) closeModal();
  });

  // ── Download ─────────────────────────────────────────────────
  function downloadMeme(id) {
    const meme = memes.find(m => m.id === id);
    if (!meme) return;
    const a = document.createElement('a');
    a.href = meme.url;
    a.download = 'meme.jpg';
    a.target = '_blank';
    a.click();
  }

  function downloadCurrent() {
    if (currentMeme) downloadMeme(currentMeme.id);
  }

  // ── Delete (password protected) ──────────────────────────────
  function promptDelete(id) {
    pendingDeleteMeme = memes.find(m => m.id === id);
    if (!pendingDeleteMeme) return;
    document.getElementById('pwInput').value = '';
    document.getElementById('pwError').textContent = '';
    document.getElementById('pwModal').classList.add('active');
    setTimeout(() => document.getElementById('pwInput').focus(), 100);
  }

  function promptDeleteModal() {
    if (!currentMeme) return;
    pendingDeleteMeme = currentMeme;
    document.getElementById('pwInput').value = '';
    document.getElementById('pwError').textContent = '';
    document.getElementById('pwModal').classList.add('active');
    setTimeout(() => document.getElementById('pwInput').focus(), 100);
  }

  function closePwModal() {
    document.getElementById('pwModal').classList.remove('active');
    pendingDeleteMeme = null;
  }

  async function checkPassword() {
    const entered = document.getElementById('pwInput').value;
    if (entered === DELETE_PASSWORD) {
      await deleteMeme(pendingDeleteMeme);
      closePwModal();
      closeModal();
    } else {
      document.getElementById('pwError').textContent = 'INCORRECT PASSWORD';
      document.getElementById('pwInput').value = '';
      document.getElementById('pwInput').focus();
    }
  }

  document.getElementById('pwInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') checkPassword();
    if (e.key === 'Escape') closePwModal();
  });

  async function deleteMeme(meme) {
    if (!meme) return;
    try {
      // Delete from Storage
      const storageRef = storage.ref(meme.path);
      await storageRef.delete();
      
      // Delete from Firestore
      await db.collection('memes').doc(meme.id).delete();
      
      showStatus('✓ Meme deleted', 'success');
      await loadMemes();
    } catch (err) {
      console.error('Delete error:', err);
      showStatus('Delete failed', 'error');
    }
  }

  // ── Status Messages ──────────────────────────────────────────
  function showStatus(msg, type = '') {
    const el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.className = 'status-msg' + (type ? ' ' + type : '');
  }

  // ── Keyboard shortcuts ───────────────────────────────────────
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeModal();
      closePwModal();
    }
  });

  // ── Initialize ───────────────────────────────────────────────
  initAuth();
</script>
</body>
</html>
